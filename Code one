# ====================================================================
# –ë–õ–û–ö 1: –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ê–£–î–ò–û (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
# ====================================================================

# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
!pip install --upgrade pip
!pip install git+https://github.com/openai/whisper.git yt-dlp
!apt-get update && apt-get install -y ffmpeg

# ====================================================================
# üéØ –ù–ê–°–¢–†–û–ô–ö–ò (–ó–ê–ü–û–õ–ù–ò–¢–ï –ó–î–ï–°–¨):
# ====================================================================

# üîó –°–°–´–õ–ö–ê –ù–ê –í–ò–î–ï–û (–µ—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç–µ —Å YouTube):
video_url = "https://www.youtube.com/watch?v=8kvMficZrIo"

# üìù –ò–ú–Ø –§–ê–ô–õ–ê (–¥–ª—è –∞—É–¥–∏–æ –∏ —Ç–µ–∫—Å—Ç–∞):
custom_filename = "–ü—É—Ç—å –≤ DevOps: –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ"

# üéõÔ∏è –†–ï–ñ–ò–ú –†–ê–ë–û–¢–´:
# True = —Å–∫–∞—á–∞—Ç—å —Å YouTube –∏ —Å—Ä–∞–∑—É —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å
# False = —Ç–æ–ª—å–∫–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å—Ä–µ–¥—É, –∞—É–¥–∏–æ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∞–º–∏
download_and_transcribe = True

# ====================================================================
# –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê
# ====================================================================

import whisper
import re
import os

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
if custom_filename.strip():
    # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
    cleaned_name = re.sub(r'[^a-zA-Z–∞-—è–ê-–Ø0-9_]', '_', custom_filename.strip())
    # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –ø–æ–¥—Ä—è–¥
    cleaned_name = re.sub(r'_+', '_', cleaned_name)
    # –£–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
    audio_filename = cleaned_name.strip('_')
else:
    # –ò–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
    audio_filename = "audio"

# –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤
audio_file = f"{audio_filename}.mp3"
txt_file = f"{audio_filename}.txt"

print(f"üéµ –ê—É–¥–∏–æ—Ñ–∞–π–ª: {audio_file}")
print(f"üìÑ –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª: {txt_file}")

if download_and_transcribe:
    print("\nüîÑ –†–µ–∂–∏–º: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Å YouTube + —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è")
    
    # –°–∫–∞—á–∏–≤–∞–µ–º –∞—É–¥–∏–æ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    print("‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–µ–º –∞—É–¥–∏–æ...")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π YouTube
    download_commands = [
        f'yt-dlp --cookies-from-browser chrome -x --audio-format mp3 -o "{audio_filename}.%(ext)s" "{video_url}"',
        f'yt-dlp --cookies-from-browser firefox -x --audio-format mp3 -o "{audio_filename}.%(ext)s" "{video_url}"',
        f'yt-dlp --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" -x --audio-format mp3 -o "{audio_filename}.%(ext)s" "{video_url}"',
        f'yt-dlp --extractor-args "youtube:player_client=web,mweb" -x --audio-format mp3 -o "{audio_filename}.%(ext)s" "{video_url}"',
        f'yt-dlp --extractor-args "youtube:player_client=android" -x --audio-format mp3 -o "{audio_filename}.%(ext)s" "{video_url}"'
    ]
    
    download_success = False
    
    for i, cmd in enumerate(download_commands, 1):
        print(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {i}/{len(download_commands)}: {cmd.split()[1:4]}")
        try:
            result = os.system(cmd)
            if result == 0 and os.path.exists(audio_file):
                download_success = True
                print(f"‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
                break
            else:
                print(f"‚ùå –ü–æ–ø—ã—Ç–∫–∞ {i} –Ω–µ—É–¥–∞—á–Ω–∞")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ–ø—ã—Ç–∫–µ {i}: {e}")
    
    if not download_success:
        print("\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏")
        print("üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:")
        print("1. –°–∫–∞—á–∞–π—Ç–µ –≤–∏–¥–µ–æ –≤—Ä—É—á–Ω—É—é –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ MP3 —Ñ–∞–π–ª")
        print("2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ")
        print("3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ (–ø—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–π)")
        print("\nüîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞...")
        
        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        download_and_transcribe = False
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        print(f"\nüìã –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –†–£–ß–ù–û–ô –ó–ê–ì–†–£–ó–ö–ò:")
        print(f"1. –°–∫–∞—á–∞–π—Ç–µ –∞—É–¥–∏–æ —Å YouTube –≤—Ä—É—á–Ω—É—é")
        print(f"2. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –∫–∞–∫: {audio_file}")
        print(f"3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ Google Colab")
        print(f"4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ë–ª–æ–∫ 2 –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏")
        
    else:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        !ls -lh "{audio_file}"
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å Whisper
        print("ü§ñ –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å Whisper...")
        model = whisper.load_model("large")
        
        # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –∞—É–¥–∏–æ
        print("üéôÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é...")
        result = model.transcribe(audio_file, fp16=False)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        with open(txt_file, "w", encoding="utf-8") as f:
            f.write(result["text"])
        
        print("‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        print(f"üìÑ –¢–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {txt_file}")
        print("\nüìù –ü–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
        print(result["text"][:300] + "..." if len(result["text"]) > 300 else result["text"])
        
else:
    print("\nüéõÔ∏è –†–µ–∂–∏–º: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ä–µ–¥—ã")
    print("üìÅ –°—Ä–µ–¥–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞")
    print(f"üí° –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–π –∞—É–¥–∏–æ—Ñ–∞–π–ª —Å –∏–º–µ–Ω–µ–º: {audio_file}")
    print("‚ñ∂Ô∏è –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ë–ª–æ–∫ 2 –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏")

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –±–ª–æ–∫–∞
with open("audio_settings.txt", "w") as f:
    f.write(f"{audio_filename}\n{audio_file}\n{txt_file}")
    
print(f"\nüíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –ë–ª–æ–∫–∞ 2")

# ====================================================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–¢–ò–õ–ò–¢–´
# ====================================================================

print("\nüîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´:")
print("‚Ä¢ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:")
print("  !ls -la")
print("‚Ä¢ –ü–æ–∫–∞–∑–∞—Ç—å –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã:")
print("  !ls -la *.mp3 *.wav *.m4a")
print("‚Ä¢ –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª:")
print(f"  !rm '{audio_file}'")
print("‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:")
print(f"  !du -h '{audio_file}'")
